#!/bin/bash

tempdir=temp
langpdu=${tempdir}/file.lan

init(){
    basepath=$(cd `dirname $0`;pwd);
    cd ${basepath}
    . .amarcres;

	if [ ! -e ${tempdir} ]; then
	    mkdir ${tempdir}
	fi
}

# update image sizeof today's file
get_image_height(){
	today=$(date '+%Y-%m-%d');
	iurl="http://res.warmcode.net/cover/";
	${DB_CON} "select book_code from book where date(ts)=\"${today}\" and image_height is null" 2>/dev/null | while read bcode
	do
	    purl="${iurl}${bcode}.png";
	    wget ${purl} -O ${tempdir}/${bcode}.png &>/dev/null;
		if [ $? -eq 0 ]; then
			# get height of the image
			height=$(identify -format '%h' ${tempdir}/${bcode}.png);
			sql="update book set image_height=${height} where book_code=\"${bcode}\"";
			${DB_CON} "${sql}" &>/dev/null;
			
		    amlog "${bcode} -${height}- ${purl}";
			rm ${tempdir}/${bcode}.png &>/dev/null;
		fi
	done
}

# get title language
get_title_lang(){
	today=$(date '+%Y-%m-%d');
	sql="select concat(book_code,book_name) from book where date(ts)=\"${today}\" and title_lang is null and opstatus !='05'";
	${DB_CON} "${sql}" 2>/dev/null | while read fitem
	do
		fname="${fitem:36}";
		fcode="${fitem:0:36}";

		amlog "${fcode} - ${fname}";
		curl -X POST \
			-H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" \
			-d "query=${fname}" \
			-o ${langpdu}\
			"https://fanyi.baidu.com/langdetect" 2>/dev/null;

		if [ $? -eq 0 ]; then
			resp=$(cat ${langpdu});
			error_code=$(jq ".error" ${langpdu});

			if [  "null" = ${error_code} ]; then
				amlog "FAILED: ${fname} / ${resp}";
			else
				lang=$(jq ".lan" ${langpdu});
				usql="update book set title_lang=${lang} where book_code=\"${fcode}\"";
				${DB_CON} "${usql}" &>/dev/null;
				amlog "OK : ${lang}";
			fi
		fi
	done
}

usage(){
    echo "Usage: $0 [options]";
	echo " -a get image height";
	echo " -l get language of document name";
}

init;

while getopts "al" opt; do
    case ${opt} in
		a){ get_image_height; exit; };;
        l){ get_title_lang; exit; };;
	esac
done

usage;
