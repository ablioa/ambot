#!/bin/bash

###############################################################################
# 命令选项
# -s 同步远程下载文件 
# -d 删除废弃的文件
# -r 从仓库中提取文件
# -f 刷新路径缓存
#
# 服务安装
# * * * * * /soft/amarc/amarc -s 1>>/soft/amarc/log/sync.txt &
# * * * * * /soft/amarc/amarc -d 1>>/soft/amarc/log/delete.txt &
# * * * * * /soft/amarc/amarc -r 1>>/soft/amarc/log/retrieve.txt &
###############################################################################

# 本地文件管理
remote_host=wangzh@warmcode.net
remote_repo_path=/data/res/in
local_repo_path=/media/hd0/repository/00
local_temp_path=temp

download_lock=.download.lock
retrieve_lock=.retrieve.lock

REDIS_PWD='abc123'
REDIS_CMD="/soft/redis/redis-master/bin/redis-cli -a ${REDIS_PWD}"

# 设置redis字串数据
redis_set(){
	dkey="$1";
	dval="$2";
	${REDIS_CMD} set "${dkey}" "${dval}" &>/dev/null;
}

# 查询redis字串数据
redis_get(){
	dkey="${1}";
	${REDIS_CMD} get "${dkey}" 2>/dev/null;
}

# 删除redis字串数据
redis_delete(){
    dkey="${1}";
	${REDIS_CMD} del "${dkey}" &>/dev/null;
}

test_redis_delete(){
	dkey="aaaa";
	redis_delete "${dkey}";
	echo "test redis delete";
}

# 同步远程下载的文件
sync(){
	if [ -e ${download_lock} ]; then
	    return;
	fi
	
	touch ${download_lock};

	files=$(ssh ${remote_host} "ls ${remote_repo_path}");
	for file in ${files[*]}
	do
		scp "${remote_host}:${remote_repo_path}/${file}" "${local_temp_path}/${file}"
		if [ $? -eq 0 ]; then
		    rmd5=$(ssh ${remote_host} "md5sum ${remote_repo_path}/${file}" | awk '{print $1}');
			lmd5=$(md5sum "temp/${file}" | awk '{print $1}');
			if [ "${lmd5}" == "${rmd5}" ]; then
			   mv ${local_temp_path}/${file} ${local_repo_path}
			   ssh ${remote_host} "rm ${remote_repo_path}/${file}";

			   dkey=$(echo ${file} | grep '[0-9a-z\-]\{36\}' -o);
			   dval="${local_repo_path}/${file}";

			   redis_set "${dkey}" "${dval}";
			   echo "${dkey} : ${dval}";
			fi
		fi
	done

	rm ${download_lock}
}

# 从仓库总移除文件
delete_from_repository(){
	${DB_CON} "select book_code from book where opstatus='04'" 2>/dev/null | while read bcode
	do
	    bpath=$(redis_get ${bcode});
	    if [ ! -z ${bpath} ]; then
		    echo "book_to_remove: ${bcode} : ${bpath}";
			mv -v "${bpath}" "trash/";
			if [ $? -eq 0 ]; then
				${DB_CON} "update book set opstatus='05' where book_code=\"${bcode}\"" &>/dev/null;
			    redis_delete "${bcode}";
			fi
		else
			echo "FILE NOT FOUND: ${bcode}";
		fi
	done;
}

# 1. 本地文件个更新进去
# 2. 删除的清除掉
refresh_redis(){
	repository_path=/media/hd0/repository/00;
	ls ${repository_path} | while read file
	do
		fcode=${file:0:36}
	    fpath="${repository_path}/${file}";
		redis_set "${fcode}" "${fpath}";
		echo "file_to_handle: ${file} : ${fcode} : ${fpath}";
	done

	echo "refresh redis";
}

# 从仓库总提取数据
retrieve_from_repository(){
    if [ -e ${retrieve_lock} ]; then
	    echo "retrieve process is already running now!";
        return;
	fi

	touch ${retrieve_lock};

    ${DB_CON} "select book_code from bag where bag_status=0" 2>/dev/null | while read bcode
	do
	    bpath=$(redis_get ${bcode});
	    if [ -z ${bpath} ]; then
			echo "文件不存在: ${bcode}";
		else
			bname=$(${DB_CON} "select concat(book_name,concat('_M',LPAD(pk_book,10,0))) from book where book_code=\"${bcode}\"");
		    echo "book_to_handle: ${bcode} -> ${bpath} -> ${bname}.pdf";
		    mv -v ${bpath} "trunk/${bname}.pdf";
			${DB_CON} "update bag set bag_status=1 where book_code=\"${bcode}\"" 2>/dev/null;
		fi
	done

	rm ${retrieve_lock}
}

usage(){
    echo "Usage: $0 [options]";
	echo "  -s 同步远程下载文件";
	echo "  -r 提取仓库文件";
	echo "  -f 刷新路径缓存";
	echo "  -t 测试功能"
	echo "  -k 根据关键字提取文件";
	echo "  -j 根据文档清单删除文件";
}

basepath=$(cd `dirname $0`;pwd);
cd ${basepath}

. .amarcres

while getopts "ftsdrkj" opt; do
    case ${opt} in
		s){ sync; exit; };;
        f){ refresh_redis; exit; };;
        t){ test_redis_delete; exit; };;
        d){ delete_from_repository; exit; };;
		r){ retrieve_from_repository; exit; };;
		k){ echo "get file with keyword."; exit; };;
		j) { echo "remove file from list"; exit; };;
	esac
done

usage;
