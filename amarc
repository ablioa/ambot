#!/bin/bash

# 本地文件管理
remote_repo_path=/data/res/in
local_repo_path=repo
local_temp_path=temp

download_lock=.download.lock
retrieve_lock=.retrieve.lock

REDIS_PWD='abc123'
REDIS_CMD="/soft/redis/redis-master/bin/redis-cli -a ${REDIS_PWD}"

redis_set(){
	dkey="$1";
	dval="$2";
	${REDIS_CMD} set "${dkey}" "${dval}" 2>/dev/null;
}

redis_get(){
	dkey="${1}";
	${REDIS_CMD} get "${dkey}" 2>/dev/null;
}

redis_api_test(){
	data_key='02a2c3ae-0535-11e9-a1f1-00163e025849'
	data_val='/media/hd1/repository/03/02a2c3ae-0535-11e9-a1f1-00163e025849.pdf'
	dval=999
	redis_set "${data_key}" "${dval}"

	newval=$(redis_get "${data_key}");
	echo "val: ${newval}"
}

# 文件下载
download(){
	files=$(ssh wangzh@warmcode.net "ls ${remote_repo_path}");

	for file in ${files[*]}
	do
		rmd5=$(ssh wangzh@warmcode.net "md5sum ${remote_repo_path}/${file}" | awk '{print $1}');
		echo "hello: ${remote_repo_path}/${file}"
		scp "wangzh@warmcode.net:${remote_repo_path}/${file}" "${local_temp_path}/${file}"
		ret=$?
		if [ ${ret} -eq 0 ]; then
		    echo "hello:1"
			lmd5=$(md5sum "temp/${file}" | awk '{print $1}');
			if [ "${lmd5}" == "${rmd5}" ]; then
			   mv ${local_temp_path}/${file} ${local_repo_path}
			   echo ${local_temp_path}/${file} ${local_repo_path}
			   ssh wangzh@warmcode.net "rm ${remote_repo_path}/${file}";
			fi
		else
			echo "hello 2: ${ret}"
		fi
	done
}

usage(){
    echo "Usage: $0 [options]";
	echo "  -d 同步远程下载文件";
	echo "  -r 提取仓库文件";
	echo "  -k 根据关键字提取文件";
	echo "  -j 根据文档清单删除文件";
}

basepath=$(cd `dirname $0`;pwd);
cd ${basepath}

while getopts "drkj" opt; do
    case ${opt} in
		d){
			echo "locl: ${download_lock}"
			if [ -e ${download_lock} ]; then
				echo "download process is already running now!";
			else
				touch ${download_lock};
				download;
				rm ${download_lock}
			fi
			exit;
		};;
		r) {
			if [ -e ${retrieve_lock} ]; then
				echo "retrieve process is already running now!";
			else
				touch ${retrieve_lock};
				download;
				rm ${retrieve_lock}
			fi
			exit;
			exit
		};;
		k) {
			echo "get file with keyword.";
			exit;
		};;
		j) {
			echo "remove file from list";
			exit ;
			exit;
		};;
	esac
done

usage;
